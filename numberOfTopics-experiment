#!/bin/sh
set -eu

set -a; . ./.env; set +a

OBJECT_FILE=$1
OUTPUT_DIR=$2
REPEATS=$3

make palmetto-0.1.0.jar palmetto-indexes

for NUMBER_OF_TOPICS in 10 20 30 40 50 60 70 80 90 100 120 140 160 180 200 250 300 400 500 750 1000; do
    for i in $(seq 1 $REPEATS); do
        MODEL_DIR="$OUTPUT_DIR/$NUMBER_OF_TOPICS/$(date +%s)_$i"
        mkdir -p "$MODEL_DIR"
        $MODEL_GENERATOR "$OBJECT_FILE" "$MODEL_DIR/model.gz" $NUMBER_OF_TOPICS
        ./topwords4palmetto <"$MODEL_DIR/top_words.csv" >"$MODEL_DIR/top_words.palmetto"
        $PALMETTO "$HOME/.local/share/palmetto/indexes/wikipedia_bd" C_P "$MODEL_DIR/top_words.palmetto" >"$MODEL_DIR/palmetto.out"
        awk 'NR > 1 { print $2 }' "$MODEL_DIR/palmetto.out" >"$MODEL_DIR/palmetto.csv"
        echo $(date +%s), $NUMBER_OF_TOPICS, $(octave -f -q --eval "X = csvread('$MODEL_DIR/palmetto.csv'); disp(mean(X));"), $(octave -f -q --eval "X = csvread('$MODEL_DIR/palmetto.csv'); disp(std(X));") >>"$OUTPUT_DIR/results.csv"
    done
done

echo "
set terminal png
set output '$OUTPUT_DIR/results.png'
set title 'Average topic quality based on number of topics (LODCat)'
set xlabel 'Number of topics'
set ylabel 'Average topic quality'
set grid
set key outside center bottom
set logscale x
set xrange [1:]
set yrange [0:1]
set style line 1 lc rgb '#0060ad' pt 7 ps 1.5 lt 1 lw 2
plot '$OUTPUT_DIR/results.csv' using 2:3:4 title '$OUTPUT_DIR' ls 1 with errorbars
" |gnuplot
